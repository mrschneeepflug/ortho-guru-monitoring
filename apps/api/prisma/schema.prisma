generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────

enum DoctorRole {
  ADMIN
  DOCTOR
  HYGIENIST
}

enum PatientStatus {
  ACTIVE
  PAUSED
  COMPLETED
  DROPPED
}

enum ScanStatus {
  PENDING
  REVIEWED
  FLAGGED
}

enum ImageType {
  FRONT
  LEFT
  RIGHT
  UPPER_OCCLUSAL
  LOWER_OCCLUSAL
}

enum SenderType {
  DOCTOR
  PATIENT
  SYSTEM
}

enum AttachmentCheck {
  YES
  NO
  UNSURE
}

// ─── Practice (Tenant) ───────────────────────────────────

model Practice {
  id               String   @id @default(cuid())
  name             String
  address          String?
  phone            String?
  subscriptionTier String   @default("basic")
  taggingRate      Float    @default(0)
  discountPercent  Float    @default(0)
  settings         Json     @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  doctors   Doctor[]
  patients  Patient[]
  auditLogs AuditLog[]

  @@map("practices")
}

// ─── Doctor ──────────────────────────────────────────────

model Doctor {
  id           String     @id @default(cuid())
  practiceId   String
  name         String
  email        String     @unique
  role         DoctorRole @default(DOCTOR)
  credentials  String?
  passwordHash String?
  auth0Id      String?    @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  practice       Practice      @relation(fields: [practiceId], references: [id])
  patients       Patient[]
  reviewedScans  ScanSession[] @relation("ReviewedBy")
  tagSets        TagSet[]

  @@index([practiceId])
  @@map("doctors")
}

// ─── Patient ─────────────────────────────────────────────

model Patient {
  id             String        @id @default(cuid())
  practiceId     String
  doctorId       String
  name           String
  email          String?       @unique
  passwordHash   String?
  dateOfBirth    DateTime?
  treatmentType  String?
  alignerBrand   String?
  currentStage   Int           @default(1)
  totalStages    Int?
  scanFrequency  Int           @default(14) // days between scans
  status         PatientStatus @default(ACTIVE)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  practice          Practice           @relation(fields: [practiceId], references: [id])
  doctor            Doctor             @relation(fields: [doctorId], references: [id])
  scanSessions      ScanSession[]
  messageThreads    MessageThread[]
  invites           PatientInvite[]
  pushSubscriptions PushSubscription[]

  @@index([practiceId])
  @@index([doctorId])
  @@map("patients")
}

// ─── Patient Invite ────────────────────────────────────

model PatientInvite {
  id        String    @id @default(cuid())
  patientId String
  token     String    @unique
  email     String?
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  patient   Patient   @relation(fields: [patientId], references: [id])

  @@index([token])
  @@map("patient_invites")
}

// ─── Scan Session ────────────────────────────────────────

model ScanSession {
  id           String     @id @default(cuid())
  patientId    String
  status       ScanStatus @default(PENDING)
  imageCount   Int        @default(0)
  reportTrayNumber   Int?
  reportAlignerFit   Int?             // 1-3: Good, Fair, Poor
  reportWearTimeHrs  Int?             // only when fit is Fair/Poor
  reportAttachments  AttachmentCheck?
  reportNotes        String?
  reviewedById String?
  reviewedAt   DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  patient    Patient     @relation(fields: [patientId], references: [id])
  reviewedBy Doctor?     @relation("ReviewedBy", fields: [reviewedById], references: [id])
  images     ScanImage[]
  tagSet     TagSet?

  @@index([patientId])
  @@index([status])
  @@map("scan_sessions")
}

// ─── Scan Image ──────────────────────────────────────────

model ScanImage {
  id           String    @id @default(cuid())
  sessionId    String
  imageType    ImageType
  s3Key        String?
  thumbnailKey String?
  localPath    String?
  qualityScore Float?
  createdAt    DateTime  @default(now())

  session ScanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("scan_images")
}

// ─── Tag Set ─────────────────────────────────────────────

model TagSet {
  id               String   @id @default(cuid())
  sessionId        String   @unique
  taggedById       String
  overallTracking  Int      // 1-3: good, fair, poor
  alignerFit       Int?     // 1-3: good, fair, poor (nullable for non-aligner)
  oralHygiene      Int      // 1-3: good, fair, poor
  detailTags       Json     @default("[]")
  actionTaken      String?
  notes            String?
  aiSuggested      Boolean  @default(false)
  aiOverridden     Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  session  ScanSession @relation(fields: [sessionId], references: [id])
  taggedBy Doctor      @relation(fields: [taggedById], references: [id])

  @@index([taggedById])
  @@map("tag_sets")
}

// ─── Message Thread ──────────────────────────────────────

model MessageThread {
  id        String   @id @default(cuid())
  patientId String
  subject   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient  Patient   @relation(fields: [patientId], references: [id])
  messages Message[]

  @@index([patientId])
  @@map("message_threads")
}

// ─── Message ─────────────────────────────────────────────

model Message {
  id          String     @id @default(cuid())
  threadId    String
  senderType  SenderType
  senderId    String
  content     String
  attachments Json       @default("[]")
  readAt      DateTime?
  createdAt   DateTime   @default(now())

  thread MessageThread @relation(fields: [threadId], references: [id])

  @@index([threadId])
  @@map("messages")
}

// ─── Audit Log ───────────────────────────────────────────

model AuditLog {
  id           String   @id @default(cuid())
  userId       String
  userRole     String
  action       String
  resourceType String
  resourceId   String?
  practiceId   String?
  ipAddress    String?
  metadata     Json     @default("{}")
  timestamp    DateTime @default(now())

  practice Practice? @relation(fields: [practiceId], references: [id])

  @@index([practiceId])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

// ─── Push Subscription ──────────────────────────────────

model PushSubscription {
  id        String   @id @default(cuid())
  patientId String
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("push_subscriptions")
}
